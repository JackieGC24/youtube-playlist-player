<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Playlist Player</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .input-section {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 8px;
            margin: 0;
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
        }

        button, select {
            padding: 8px 16px;
            margin: 0;
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            white-space: nowrap;
        }

        button {
            cursor: pointer;
        }

        button:hover {
            background-color: #444;
        }

        #player-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        #playlist-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
        }

        .playlist-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #444;
            touch-action: manipulation;
        }

        .playlist-item:hover {
            background-color: #333;
        }

        .playlist-item.active {
            background-color: #444;
        }

        .controls {
            margin: 10px 0;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .loading {
            display: none;
            margin-left: 10px;
            color: #888;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .video-counter {
            margin-left: 10px;
            color: #888;
        }

        .playlist-title {
            font-size: 1.8em;
            padding: 15px 0;
            color: #fff;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .nav-button {
            padding: 8px 20px;
            background-color: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .nav-button:hover {
            background-color: #444;
        }

        .playlist-header {
            display: flex;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
        }

        .playlist-title {
            flex: 1;
            font-size: 1.8em;
            color: #fff;
            padding: 0;
            border-bottom: none;
            margin-bottom: 0;
            font-weight: 500;
        }

        .video-counter {
            color: #888;
            margin-left: 15px;
            font-size: 1.2em;
        }

        .welcome-container {
            text-align: center;
            padding: 40px 20px;
            background-color: #2a2a2a;
            border-radius: 8px;
            margin: 20px 0;
        }

        .welcome-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #fff;
        }

        .welcome-text {
            color: #aaa;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .example-text {
            color: #888;
            font-family: monospace;
            background-color: #333;
            padding: 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }

        .example-section {
            margin-top: 30px;
            opacity: 0.6;
        }

        .example-label {
            color: #888;
            font-style: italic;
            margin: 20px 0 10px 0;
        }

        .example-playlist-item {
            padding: 8px;
            background-color: #333;
            border-bottom: 1px solid #444;
            color: #aaa;
        }

        .example-playlist-header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #444;
            margin-bottom: 15px;
        }

        .example-state {
            opacity: 0.6;
        }

        #initial-example {
            margin: 20px 0;
            border-bottom: none;
        }

        .resume-button {
            background-color: #2a6b2a;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .resume-button:hover {
            background-color: #357a35;
        }

        .error-message {
            background-color: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .api-warning {
            background-color: #2a2a2a;
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        #playlist-title {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .loop-control {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #fff;
            margin-left: 15px;
            cursor: pointer;
            padding: 8px 0;
        }

        .loop-control input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            margin: 0;
            accent-color: #444;
        }

        .playlist-title a {
            color: #fff;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .playlist-title a:hover {
            color: #ff0000; /* YouTube red */
            text-decoration: none;
        }

        .playlist-title a:visited {
            color: #fff;
        }

        .playlist-title a:visited:hover {
            color: #ff0000;
        }

        .playlist-history {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        .history-title {
            font-size: 1.2em;
            color: #fff;
            margin-bottom: 15px;
        }

        .history-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #fff;
        }

        .history-item:hover {
            background-color: #444;
        }

        .playlist-title-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .playlist-links-dropdown {
            position: relative;
            display: inline-block;
        }

        .playlist-links-dropdown .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .playlist-links-dropdown:hover .dropdown-content {
            display: block;
        }

        .playlist-links-dropdown .dropdown-content a {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-links-dropdown .dropdown-content a:hover {
            background-color: #444;
        }

        .playlist-favorites {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        .favorites-title {
            font-size: 1.2em;
            color: #fff;
            margin-bottom: 15px;
        }

        .favorite-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0 15px;
            transition: transform 0.2s ease;
        }

        .favorite-button:hover {
            transform: scale(1.1);
        }

        .delete-button {
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            padding: 0 8px;
            margin-left: 8px;
            transition: color 0.2s;
        }

        .delete-button:hover {
            color: #ff4444;
        }

        .history-item, .favorite-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .history-item:hover, .favorite-item:hover {
            background-color: #444;
        }

        #version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: #666;
            font-size: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            animation: flashNotification 0.3s ease;
        }

        @keyframes flashNotification {
            0% {
                background-color: #fff;
                color: #333;
            }
            100% {
                background-color: #333;
                color: #fff;
            }
        }

        .section-header {
            position: relative;
            text-align: center;
            padding: 10px 20px;
            margin: 0;
        }

        .section-header h3 {
            display: inline;  /* Keep header inline */
            margin: 0;
            font-weight: normal;
            position: relative;  /* For positioning the clear button */
        }

        .clear-button {
            position: absolute;
            left: calc(50% + 85px);  /* Increased offset to prevent overlap */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .clear-button:hover {
            color: #ff4444;
            background-color: rgba(255, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <input type="text" id="playlist-input" placeholder="Enter YouTube Playlist URL or ID">
            <button onclick="loadPlaylist()">Load Playlist</button>
            <button id="add-playlist-button" onclick="addPlaylist()" style="display: none;">Add to Current</button>
            <button onclick="shufflePlaylist()">Shuffle</button>
            <select id="size-selector" onchange="resizePlayer(); saveSession()">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
            </select>
            <button id="resume-button" class="resume-button" onclick="resumeLastSession()">Resume Last Session</button>
            <span id="loading" class="loading">Loading playlist...</span>
        </div>

        <div id="error-message" class="error-message"></div>

        <div id="welcome-section" class="welcome-container">
            <div class="welcome-title">YouTube Playlist Player</div>
            <div class="welcome-text">
                Enter a YouTube playlist URL or ID to get started<br>
                You can enter either a full URL:
            </div>
            <div class="example-text">
                https://www.youtube.com/playlist?list=PLxxx...
            </div>
            <div class="welcome-text">
                Or just the playlist ID:
            </div>
            <div class="example-text">
                PLxxx...
            </div>
            
            <div id="playlist-favorites" class="playlist-favorites">
                <div class="favorites-title">Favorite Playlists</div>
                <div id="favorites-items"></div>
            </div>

            <div id="playlist-history" class="playlist-history">
                <div class="section-header">
                    <h3>Recent Playlists</h3>
                    <button class="clear-button" onclick="clearHistory()" title="Clear history">clear</button>
                </div>
                <div id="history-items"></div>
            </div>
        </div>

        <div id="player-container"></div>
        
        <div class="nav-controls example-state" id="initial-controls">
            <button class="nav-button" disabled>Previous</button>
            <button class="nav-button" disabled>Next</button>
        </div>

        <div class="nav-controls" id="actual-controls" style="display: none;">
            <button class="nav-button" onclick="playPrevious()">Previous</button>
            <button class="nav-button" onclick="playNext()">Next</button>
            <label class="loop-control">
                <input type="checkbox" id="loop-checkbox">
                Loop Playlist
            </label>
        </div>

        <div class="playlist-header" id="actual-playlist-header" style="display: none;">
            <div id="playlist-title" class="playlist-title"></div>
            <button id="favorite-button" onclick="toggleFavorite()" class="favorite-button">☆</button>
            <div id="video-counter" class="video-counter"></div>
        </div>

        <div id="playlist-container" style="display: none;"></div>
    </div>

    <script>
        let player;
        let playerReady = false;
        let playerReadyResolve;
        const playerReadyPromise = new Promise((resolve) => {
            playerReadyResolve = resolve;
        });

        let apiLoaded = false;
        let apiLoadPromise = null;

        let playlistItems = [];
        let originalPlaylist = [];
        let playedVideos = [];
        let currentIndex = 0;

        function initializePlayer() {
            console.log('Initializing player...');
            player = new YT.Player('player-container', {
                height: '480',
                width: '853',
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'origin': window.location.origin,
                    'modestbranding': 1,
                    'showinfo': 0,
                    'enablejsapi': 1
                },
                events: {
                    'onReady': function(event) {
                        console.log('Player ready');
                        playerReady = true;
                        if (playerReadyResolve) {
                            playerReadyResolve();
                        }
                    },
                    'onStateChange': onPlayerStateChange,
                    'onError': function(event) {
                        console.error('Player Error:', event);
                    }
                }
            });
        }

        // Prevent thumbnail preview requests
        if (typeof YT !== 'undefined' && YT.PlayerState) {
            YT.PlayerState.UNSTARTED = -1;
            YT.PlayerState.ENDED = 0;
            YT.PlayerState.PLAYING = 1;
            YT.PlayerState.PAUSED = 2;
            YT.PlayerState.BUFFERING = 3;
            YT.PlayerState.CUED = 5;
        }

        // Handle player state changes
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                const isLooping = document.getElementById('loop-checkbox').checked;
                if (isLooping || currentIndex < playlistItems.length - 1) {
                    playNext();
                }
            } else if (event.data === YT.PlayerState.UNSTARTED) {
                // Check if video is playable after a short delay
                setTimeout(() => {
                    const playerState = player.getPlayerState();
                    if (playerState === YT.PlayerState.UNSTARTED) {
                        console.log('Video unplayable, skipping to next...');
                        playNext();
                    }
                }, 2000);  // 2 second delay to allow video to start
            }
        }

        // Extract playlist ID from URL or direct ID
        function getPlaylistId(input) {
            if (!input) return null;
            
            // Clean the input
            input = String(input).trim();
            
            // Handle full URLs
            const urlMatch = input.match(/[?&]list=([A-Za-z0-9_-]+)/);
            if (urlMatch) return urlMatch[1];
            
            // Handle direct IDs
            const idMatch = input.match(/^([A-Za-z0-9_-]+)$/);
            if (idMatch) return idMatch[1];
            
            return null;
        }

        // Update loadPlaylist function to handle playlist combinations
        async function loadPlaylist(preventAutoPlay = false) {
            const loadingIndicator = document.getElementById('loading');
            const errorMsg = document.getElementById('error-message');
            const inputElement = document.getElementById('playlist-input');
            const welcomeSection = document.getElementById('welcome-section');
            
            try {
                // Show loading state
                if (loadingIndicator) loadingIndicator.style.display = 'inline';
                if (errorMsg) errorMsg.style.display = 'none';

                const input = inputElement.value.trim();
                const playlistId = getPlaylistId(input);
                if (!playlistId) {
                    throw new Error('Invalid playlist URL or ID');
                }

                // Load YouTube API and wait for it
                await loadYouTubeAPI();

                // Initialize player if needed
                if (!player) {
                    initializePlayer();
                    await playerReadyPromise;
                }

                // Fetch playlist items
                const items = await fetchPlaylistItems(playlistId);
                
                if (!items || items.length === 0) {
                    throw new Error('No videos found in playlist');
                }

                // Check if we're adding to existing playlist
                const addButton = document.getElementById('add-playlist-button');
                const isAdding = addButton && 
                               addButton.style.display === 'inline' &&
                               addButton.dataset.adding === 'true';

                if (!isAdding) {
                    // New playlist load
                    playlistItems = items;
                    currentIndex = 0;
                } else {
                    // Adding to existing playlist - don't change currentIndex
                    // Don't combine here - let addPlaylist handle it
                    playlistItems = items;
                }

                // Hide welcome section completely
                if (welcomeSection) {
                    welcomeSection.style.display = 'none';
                }

                document.getElementById('initial-controls').style.display = 'none';
                document.getElementById('playlist-container').style.display = 'block';
                document.getElementById('actual-controls').style.display = 'flex';
                document.getElementById('actual-playlist-header').style.display = 'flex';
                document.getElementById('add-playlist-button').style.display = 'inline';

                // Save to history
                if (items[0] && items[0].snippet) {
                    saveToHistory(playlistId, items[0].snippet.playlistTitle);
                }

                // Initialize played videos only for new playlist loads
                if (!isAdding) {
                    playedVideos = [items[0]];
                }
                
                // Display playlist
                displayPlaylist();

                // Only load first video if this is a new playlist load and not prevented
                if (!isAdding && !preventAutoPlay) {
                    const firstVideoId = items[0].snippet.resourceId.videoId;
                    player.loadVideoById(firstVideoId);
                }

                displayFavorites();
                updateFavoriteButton();

            } catch (error) {
                console.error('Error:', error);
                if (errorMsg) {
                    errorMsg.style.display = 'block';
                    errorMsg.textContent = `Error: ${error.message}`;
                }
                document.getElementById('add-playlist-button').style.display = 'none';
                
                // Show welcome section if there's an error
                if (welcomeSection) {
                    welcomeSection.style.display = 'block';
                }
                displayHistory();
                
                throw error;
            } finally {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        // Fetch playlist items using YouTube Data API
        async function fetchPlaylistItems(playlistId, pageToken = '', items = []) {
            console.log(`Starting fetch for playlist: ${playlistId}`);
            
            const apiKey = 'AIzaSyBZ4Ow6AF03kHdJrbeYODzJ8FFNKZ-iTVE';
            //const apiKey = 'AIzaSyD4nA8bLUU8rUqx6dZwIOV7x6EXyFPru9w';
            const maxResults = 50;
            
            try {
                // First, get the playlist title
                const playlistUrl = `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${apiKey}`;
                const playlistResponse = await fetch(playlistUrl);
                const playlistData = await playlistResponse.json();
                
                if (playlistData.error) {
                    throw new Error(playlistData.error.message);
                }

                const playlistTitle = playlistData.items?.[0]?.snippet?.title || 'Playlist';
                
                // Now fetch the playlist items
                const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=${maxResults}&playlistId=${playlistId}&key=${apiKey}${pageToken ? '&pageToken=' + pageToken : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (!data.items || data.items.length === 0) {
                    throw new Error('No videos found in playlist');
                }

                // Add playlist title to each item
                const itemsWithTitle = data.items.map(item => ({
                    ...item,
                    snippet: {
                        ...item.snippet,
                        playlistTitle: playlistTitle
                    }
                }));

                items.push(...itemsWithTitle);

                if (data.nextPageToken) {
                    return fetchPlaylistItems(playlistId, data.nextPageToken, items);
                }

                return items;
            } catch (error) {
                console.error('Error in fetchPlaylistItems:', error);
                throw error;
            }
        }

        // Add this helper function for creating combined titles
        function createCombinedTitle(titles) {
            if (!titles || titles.length === 0) return 'Playlist';
            
            // If only one playlist, return its title
            if (titles.length === 1) return titles[0];
            
            // For multiple playlists, create a smart combined name
            const maxLength = 50; // Maximum characters for combined title
            
            // Option 1: Show count if too many playlists
            if (titles.length > 3) {
                return `Combined Playlist (${titles.length} playlists)`;
            }
            
            // Option 2: Try to combine names with truncation
            const combinedTitle = titles.join(' + ');
            if (combinedTitle.length <= maxLength) {
                return combinedTitle;
            }
            
            // Option 3: Show first playlist + count
            return `${titles[0].substring(0, 30)}... (+${titles.length - 1} more)`;
        }

        // Update displayPlaylist function to handle multiple playlist links
        function displayPlaylist() {
            const container = document.getElementById('playlist-container');
            const playlistTitle = document.getElementById('playlist-title');
            
            if (playlistTitle) {
                const existingHistory = JSON.parse(localStorage.getItem('playlistHistory') || '[]')[0];
                let titles = [playlistItems[0].snippet.playlistTitle];
                let ids = [getPlaylistId(document.getElementById('playlist-input').value)];
                
                // Get all titles and IDs from history if they exist
                if (existingHistory && existingHistory.titles && existingHistory.ids) {
                    titles = existingHistory.titles;
                    ids = existingHistory.ids;
                }
                
                const combinedTitle = createCombinedTitle(titles);
                
                // Create dropdown menu for multiple playlists
                if (ids.length > 1) {
                    playlistTitle.innerHTML = `
                        <div class="playlist-title-container">
                            <span>${combinedTitle}</span>
                            <div class="playlist-links-dropdown">
                                <span>▼</span>
                                <div class="dropdown-content">
                                    ${titles.map((title, i) => 
                                        `<a href="https://www.youtube.com/playlist?list=${ids[i]}" 
                                            target="_blank">${title}</a>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Single playlist - just show direct link
                    playlistTitle.innerHTML = `
                        <a href="https://www.youtube.com/playlist?list=${ids[0]}" 
                           target="_blank">${combinedTitle}</a>
                    `;
                }
            }

            if (!container || !playlistItems || playlistItems.length === 0) return;

            container.innerHTML = ''; // Clear existing content
            
            // Create and append playlist items
            playlistItems.forEach((item, index) => {
                if (item && item.snippet) {
                    const div = document.createElement('div');
                    div.className = 'playlist-item';
                    if (index === currentIndex) {
                        div.classList.add('active');
                    }
                    div.textContent = item.snippet.title;
                    div.onclick = () => playVideo(index);
                    container.appendChild(div);

                    // If this is the current item, scroll it into view
                    if (index === currentIndex) {
                        // Use setTimeout to ensure DOM is updated
                        setTimeout(() => {
                            div.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                }
            });

            // Update video counter
            const counter = document.getElementById('video-counter');
            if (counter) {
                counter.textContent = `${currentIndex + 1}/${playlistItems.length}`;
            }
        }

        // Play video at specific index
        async function playVideo(index) {
            if (!playlistItems || !playlistItems[index]) {
                console.error('Invalid video index or no playlist loaded');
                return;
            }

            try {
                if (!playerReady) {
                    await playerReadyPromise;
                }

                currentIndex = index;
                const videoItem = playlistItems[index];
                const videoId = videoItem.snippet.resourceId.videoId;

                // Update played videos history
                const lastPlayed = playedVideos[playedVideos.length - 1];
                if (!lastPlayed || lastPlayed.snippet.resourceId.videoId !== videoId) {
                    playedVideos.push(videoItem);
                }
                
                // Update player
                player.loadVideoById(videoId);
                
                // Update UI
                displayPlaylist();
                
                // Save session
                saveSession();

                // Hide error message if video loads
                const errorMsg = document.getElementById('error-message');
                if (errorMsg) {
                    errorMsg.style.display = 'none';
                }

            } catch (error) {
                console.error('Error playing video:', error);
                // Only show error message if video isn't playing
                if (player.getPlayerState() === -1) {  // -1 means unstarted
                    const errorMsg = document.getElementById('error-message');
                    if (errorMsg) {
                        errorMsg.style.display = 'block';
                        errorMsg.textContent = 'Error playing video. Please try again.';
                    }
                }
            }
        }

        // Play next video
        function playNext() {
            if (!playlistItems || playlistItems.length === 0) return;

            const isLooping = document.getElementById('loop-checkbox').checked;
            
            // Calculate next index
            let nextIndex = currentIndex + 1;
            
            // If we're at the end
            if (nextIndex >= playlistItems.length) {
                if (isLooping) {
                    // Loop back to start if looping is enabled
                    nextIndex = 0;
                } else {
                    // Stop at the end if not looping
                    return;
                }
            }
            
            currentIndex = nextIndex;
            playVideo(currentIndex);
        }

        // Shuffle playlist
        function shufflePlaylist() {
            if (!playlistItems || playlistItems.length === 0) return;

            // Save current video
            const currentVideo = playlistItems[currentIndex];
            
            // Create a copy of the playlist without current video
            let remainingVideos = playlistItems.filter((_, index) => index !== currentIndex);
            
            // Shuffle remaining videos
            for (let i = remainingVideos.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remainingVideos[i], remainingVideos[j]] = [remainingVideos[j], remainingVideos[i]];
            }
            
            // Put current video back at top
            playlistItems = [currentVideo, ...remainingVideos];
            currentIndex = 0;
            
            // Reset played videos array
            playedVideos = [currentVideo];
            
            // Update display
            displayPlaylist();
            
            // Save the current state
            saveSession();
        }

        // Update active item in playlist
        function updateActiveItem() {
            const items = document.getElementsByClassName('playlist-item');
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('active');
            }
            if (items[currentIndex]) {
                items[currentIndex].classList.add('active');
            }
        }

        // Resize player
        function resizePlayer() {
            const size = document.getElementById('size-selector').value;
            const container = document.getElementById('player-container');
            
            switch(size) {
                case 'small':
                    player.setSize(427, 240);
                    break;
                case 'medium':
                    player.setSize(853, 480);
                    break;
                case 'large':
                    player.setSize(1280, 720);
                    break;
            }
        }

        function playPrevious() {
            if (!playlistItems || playlistItems.length === 0) return;

            // Move to previous index, loop to end if at start
            currentIndex = (currentIndex - 1 + playlistItems.length) % playlistItems.length;
            playVideo(currentIndex);
        }

        // Save session data
        function saveSession() {
            const sessionData = {
                playlistId: getPlaylistId(document.getElementById('playlist-input').value),
                currentIndex: currentIndex,
                playlistItems: playlistItems,
                playedVideos: playedVideos,
                isLooping: document.getElementById('loop-checkbox').checked,
                playerSize: document.getElementById('size-selector').value,
                lastPlayedIndex: currentIndex
            };
            localStorage.setItem('youtubePlayerSession', JSON.stringify(sessionData));
        }

        // Add helper function to update playlist highlighting
        function updatePlaylistHighlight(index) {
            console.log('Updating playlist highlight for index:', index);
            const playlistItems = document.querySelectorAll('.playlist-item');
            playlistItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('playing');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    console.log('Added playing class to item:', i);
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        // Add function to update video counter
        function updateVideoCounter(index, total) {
            const counterElement = document.querySelector('.counter');
            if (counterElement) {
                counterElement.textContent = `${index + 1}/${total}`;
            }
        }

        // Update resumeLastSession function with debug logging
        function resumeLastSession() {
            try {
                const savedSession = JSON.parse(localStorage.getItem('youtubePlayerSession') || '{}');
                const history = JSON.parse(localStorage.getItem('playlistHistory') || '[]');
                
                console.log('Saved session:', savedSession); // Debug log
                console.log('History:', history); // Debug log
                
                if (!history.length || !history[0].ids || !history[0].ids.length) {
                    return;
                }

                const lastSession = history[0];
                const input = document.getElementById('playlist-input');
                input.value = lastSession.ids[0];

                loadPlaylist().then(() => {
                    const welcomeSection = document.getElementById('welcome-section');
                    const resumeButton = document.getElementById('resume-button');
                    if (welcomeSection) welcomeSection.style.display = 'none';
                    if (resumeButton) resumeButton.style.display = 'none';

                    const waitForPlaylist = setInterval(() => {
                        if (playlistItems && playlistItems.length > 0) {
                            clearInterval(waitForPlaylist);
                            
                            // Use the saved currentIndex directly
                            if (typeof savedSession.currentIndex === 'number' && player) {
                                console.log('Resuming at index:', savedSession.currentIndex); // Debug log
                                
                                // Set the current index
                                currentIndex = savedSession.currentIndex;
                                
                                // Get the video ID for the current index
                                const videoId = playlistItems[currentIndex].snippet.resourceId.videoId;
                                console.log('Loading video ID:', videoId); // Debug log
                                
                                // Update counter
                                const counterElement = document.querySelector('.counter');
                                if (counterElement) {
                                    counterElement.textContent = `${currentIndex + 1}/${playlistItems.length}`;
                                }
                                
                                // Update playlist highlighting
                                const allItems = document.querySelectorAll('.playlist-item');
                                allItems.forEach((item, index) => {
                                    item.classList.toggle('playing', index === currentIndex);
                                });

                                // Scroll to current item
                                const currentItem = allItems[currentIndex];
                                if (currentItem) {
                                    currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }

                                // Load the video
                                player.loadVideoById(videoId);
                            }

                            // Load additional playlists
                            if (lastSession.ids.length > 1) {
                                const savedIndex = currentIndex;  // Save position after first playlist loads
                                
                                for (let i = 1; i < lastSession.ids.length; i++) {
                                    new Promise(resolve => setTimeout(resolve, 1500)).then(() => {
                                        const currentItems = [...playlistItems];  // Save current items
                                        
                                        input.value = lastSession.ids[i];
                                        loadPlaylist();
                                    });
                                    
                                    // Combine while maintaining position
                                    playlistItems = [...currentItems, ...playlistItems];
                                    currentIndex = savedIndex;  // Keep original position
                                    displayPlaylist();
                                }
                            }
                        }
                    }, 100);
                }).catch(error => {
                    console.error('Error resuming session:', error);
                });
            } catch (e) {
                console.error('Error in resumeLastSession:', e);
            }
        }

        // Add event listener for video index changes
        window.addEventListener('videoIndexChanged', (event) => {
            updateVideoCounter(event.detail.index, event.detail.total);
        });

        // Check if there's a saved session on page load
        window.addEventListener('load', function() {
            const savedSession = localStorage.getItem('youtubePlayerSession');
            if (!savedSession) {
                document.getElementById('resume-button').style.display = 'none';
            }
        });

        // Load YouTube IFrame API with error handling
        function loadYouTubeAPI() {
            if (apiLoadPromise) return apiLoadPromise;
            
            apiLoadPromise = new Promise((resolve) => {
                if (window.YT) {
                    apiLoaded = true;
                    resolve();
                    return;
                }

                window.onYouTubeIframeAPIReady = function() {
                    console.log('YouTube API loaded');
                    apiLoaded = true;
                    resolve();
                };

                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            });

            return apiLoadPromise;
        }

        // Initialize everything with proper error handling
        async function initializeApplication() {
            try {
                await loadYouTubeAPI();
                // Additional initialization can go here
            } catch (error) {
                console.error('Failed to initialize application:', error);
                const errorMsg = document.getElementById('error-message');
                errorMsg.style.display = 'block';
                errorMsg.textContent = 'Failed to load YouTube player. Please check your connection and refresh the page.';
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', initializeApplication);

        document.addEventListener('DOMContentLoaded', () => {
            // Show initial UI state
            const exampleSection = document.getElementById('example-section');
            const playlistContainer = document.getElementById('playlist-container');
            
            if (exampleSection) {
                exampleSection.style.display = 'block';
            }
            if (playlistContainer) {
                playlistContainer.style.display = 'none';
            }
        });

        // Add this new function to fetch playlist details
        async function fetchPlaylistDetails(playlistId) {
            //const apiKey = 'AIzaSyBZ4Ow6AF03kHdJrbeYODzJ8FFNKZ-iTVE'; // Your API key
            const apiKey = 'AIzaSyD4nA8bLUU8rUqx6dZwIOV7x6EXyFPru9w';
            const url = `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${apiKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.items && data.items.length > 0) {
                    return {
                        title: data.items[0].snippet.title,
                        description: data.items[0].snippet.description
                    };
                }
                
                throw new Error('Playlist not found');
            } catch (error) {
                console.error('Error fetching playlist details:', error);
                return { title: 'Playlist', description: '' };
            }
        }

        function saveToHistory(playlistId, title) {
            try {
                // Clean up the inputs and ensure uniqueness
                const ids = Array.isArray(playlistId) ? [...new Set(playlistId)] : [playlistId];
                let titles = Array.isArray(title) ? [...new Set(title)] : [title];
                
                // Don't split titles by comma - treat each title as a whole
                titles = titles.map(t => t.trim()).filter(t => t);

                // Get existing history
                let history = [];
                const stored = localStorage.getItem('playlistHistory');
                if (stored) {
                    history = JSON.parse(stored);
                }

                // Create new entry - ONLY combine if explicitly adding to current playlist
                const addPlaylistButton = document.getElementById('add-playlist-button');
                const isExplicitlyAdding = addPlaylistButton && 
                                         addPlaylistButton.style.display === 'inline' &&
                                         addPlaylistButton.dataset.adding === 'true';

                let newEntry;
                if (isExplicitlyAdding && history.length > 0) {
                    const current = history[0];
                    newEntry = {
                        ids: [...new Set([...current.ids, ...ids])],  // Ensure uniqueness when combining
                        titles: [...new Set([...current.titles, ...titles])],  // Ensure uniqueness when combining
                        timestamp: Date.now()
                    };
                    history.shift();
                } else {
                    // Create new single entry for fresh loads
                    newEntry = {
                        ids: ids,
                        titles: titles,
                        timestamp: Date.now()
                    };
                }

                // Add new entry to start of history
                history.unshift(newEntry);
                history = history.slice(0, 5);
                localStorage.setItem('playlistHistory', JSON.stringify(history));
                displayHistory();
                
            } catch (e) {
                console.error('Error saving history:', e);
            }
        }

        // Clean up addPlaylist function
        async function addPlaylist() {
            try {
                const addButton = document.getElementById('add-playlist-button');
                addButton.dataset.adding = 'true';

                // Store the current playlist items and index
                const currentItems = [...playlistItems];
                const savedIndex = currentIndex;
                
                // Load and combine the new playlist
                await loadPlaylist(true);  // Prevent autoplay
                
                // Combine the playlists and restore index
                playlistItems = [...currentItems, ...playlistItems];
                currentIndex = savedIndex;  // Restore the previous position
                
                // Update the display
                displayPlaylist();
                
                // Update the video counter
                const counter = document.getElementById('video-counter');
                if (counter) {
                    counter.textContent = `${currentIndex + 1}/${playlistItems.length}`;
                }
                
            } catch (e) {
                console.error('Error adding playlist:', e);
                showNotification('Error adding playlist');
            } finally {
                const addButton = document.getElementById('add-playlist-button');
                addButton.dataset.adding = 'false';
            }
        }

        // Add function to clean up invalid history entries
        function cleanupPlaylistHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('playlistHistory') || '[]');
                
                // Filter out invalid entries
                const validHistory = history.filter(entry => {
                    return entry 
                        && Array.isArray(entry.ids) 
                        && entry.ids.length > 0
                        && Array.isArray(entry.titles)
                        && entry.titles.length > 0
                        && entry.timestamp;
                });

                // If entries were removed, show notification
                if (validHistory.length !== history.length) {
                    const removedCount = history.length - validHistory.length;
                    showNotification(`Cleaned up ${removedCount} invalid playlist${removedCount !== 1 ? 's' : ''} from history`);
                    localStorage.setItem('playlistHistory', JSON.stringify(validHistory));
                }
                
                return validHistory;
            } catch (e) {
                console.error('Error cleaning history:', e);
                showNotification('History data was reset due to corruption');
                localStorage.setItem('playlistHistory', '[]');
                return [];
            }
        }

        // Update displayHistory to use the cleanup function
        function displayHistory() {
            const historyContainer = document.getElementById('history-items');
            
            if (!historyContainer) return;

            try {
                const history = cleanupPlaylistHistory();
                historyContainer.innerHTML = '';

                if (history.length === 0) {
                    historyContainer.innerHTML = '<div class="history-item">No recent playlists</div>';
                    return;
                }

                history.forEach((entry, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'history-item';
                    
                    // Create container with relative positioning
                    const contentDiv = document.createElement('div');
                    contentDiv.style.position = 'relative';
                    contentDiv.style.textAlign = 'center';
                    
                    // Create title span
                    const titleSpan = document.createElement('span');
                    const mainTitle = entry.titles[0] || 'Untitled Playlist';
                    const additionalCount = entry.titles.length - 1;
                    titleSpan.textContent = additionalCount > 0 
                        ? `${mainTitle} (+${additionalCount} more)`
                        : mainTitle;
                    
                    // Create delete button with absolute positioning
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.className = 'delete-button';
                    deleteBtn.title = 'Remove from history';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.right = '0';
                    deleteBtn.style.top = '50%';
                    deleteBtn.style.transform = 'translateY(-50%)';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        history.splice(index, 1);
                        localStorage.setItem('playlistHistory', JSON.stringify(history));
                        displayHistory();
                    };
                    
                    contentDiv.appendChild(titleSpan);
                    contentDiv.appendChild(deleteBtn);
                    itemDiv.appendChild(contentDiv);
                    
                    // Update the history item click handler
                    itemDiv.onclick = async () => {
                        try {
                            const input = document.getElementById('playlist-input');
                            
                            // Remove any duplicate playlist IDs and log them
                            const uniqueIds = [...new Set(entry.ids)];
                            console.log('Original IDs:', entry.ids);
                            console.log('Unique IDs:', uniqueIds);
                            
                            // Load first playlist normally
                            console.log('Loading first playlist:', uniqueIds[0]);
                            input.value = uniqueIds[0];
                            await loadPlaylist();
                            
                            // Load additional playlists without auto-playing
                            if (uniqueIds.length > 1) {
                                const addButton = document.getElementById('add-playlist-button');
                                addButton.dataset.adding = 'true';
                                
                                for (let i = 1; i < uniqueIds.length; i++) {
                                    console.log(`Loading additional playlist ${i}:`, uniqueIds[i]);
                                    await new Promise(resolve => setTimeout(resolve, 1500));
                                    input.value = uniqueIds[i];
                                    await loadPlaylist(true);  // Prevent auto-play
                                }
                                
                                addButton.dataset.adding = 'false';
                            }

                            console.log('Final playlist items:', playlistItems.length);
                            
                        } catch (error) {
                            console.error('Error loading playlist:', error);
                            const errorMsg = document.getElementById('error-message');
                            if (errorMsg) {
                                errorMsg.textContent = `Error: ${error.message}`;
                                errorMsg.style.display = 'block';
                            }
                        }
                    };
                    
                    historyContainer.appendChild(itemDiv);
                });

            } catch (e) {
                console.error('Error in displayHistory:', e);
                historyContainer.innerHTML = '<div class="history-item">Error loading history</div>';
            }
        }

        // Update toggleFavorite function to handle combined playlists
        function toggleFavorite() {
            const input = document.getElementById('playlist-input');
            const history = JSON.parse(localStorage.getItem('playlistHistory') || '[]');
            
            // Get the current playlist info from history
            const currentPlaylist = history[0];
            
            if (!currentPlaylist || !currentPlaylist.ids || !currentPlaylist.titles) return;
            
            try {
                let favorites = JSON.parse(localStorage.getItem('playlistFavorites') || '[]');
                
                // Check if playlist is already in favorites
                const existingIndex = favorites.findIndex(entry => 
                    JSON.stringify(entry.ids) === JSON.stringify(currentPlaylist.ids)
                );
                
                if (existingIndex === -1) {
                    // Add to favorites
                    favorites.unshift(currentPlaylist);
                } else {
                    // Remove from favorites
                    favorites.splice(existingIndex, 1);
                }
                
                localStorage.setItem('playlistFavorites', JSON.stringify(favorites));
                updateFavoriteButton();
                displayFavorites();
                showNotification(existingIndex === -1 ? 'Added to favorites' : 'Removed from favorites');
            } catch (e) {
                console.error('Error toggling favorite:', e);
                showNotification('Error updating favorites');
            }
        }

        function updateFavoriteButton() {
            const existingHistory = JSON.parse(localStorage.getItem('playlistHistory') || '[]')[0];
            const favorites = JSON.parse(localStorage.getItem('playlistFavorites') || '[]');
            const isFavorited = favorites.some(fav => 
                JSON.stringify(fav.ids) === JSON.stringify(existingHistory?.ids)
            );
            
            const starButton = document.getElementById('favorite-button');
            if (starButton) {
                starButton.innerHTML = isFavorited ? '★' : '☆';
                starButton.style.color = isFavorited ? '#ffd700' : '#fff';
            }
        }

        function displayFavorites() {
            const container = document.getElementById('favorites-items');
            if (!container) return;

            try {
                const favorites = JSON.parse(localStorage.getItem('playlistFavorites') || '[]');
                container.innerHTML = '';

                if (!Array.isArray(favorites) || favorites.length === 0) {
                    container.innerHTML = '<div class="favorite-item">No favorite playlists</div>';
                    return;
                }

                favorites.forEach((entry, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'favorite-item';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.style.position = 'relative';
                    contentDiv.style.textAlign = 'center';
                    
                    const titleSpan = document.createElement('span');
                    const mainTitle = entry.titles[0] || 'Untitled Playlist';
                    const additionalCount = entry.titles.length - 1;
                    titleSpan.textContent = additionalCount > 0 
                        ? `${mainTitle} (+${additionalCount} more)`
                        : mainTitle;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.className = 'delete-button';
                    deleteBtn.title = 'Remove from favorites';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.right = '0';
                    deleteBtn.style.top = '50%';
                    deleteBtn.style.transform = 'translateY(-50%)';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        favorites.splice(index, 1);
                        localStorage.setItem('playlistFavorites', JSON.stringify(favorites));
                        displayFavorites();
                        updateFavoriteButton();
                    };
                    
                    contentDiv.appendChild(titleSpan);
                    contentDiv.appendChild(deleteBtn);
                    itemDiv.appendChild(contentDiv);
                    
                    itemDiv.onclick = async () => {
                        try {
                            const input = document.getElementById('playlist-input');
                            input.value = entry.ids[0];
                            await loadPlaylist();
                            
                            for (let i = 1; i < entry.ids.length; i++) {
                                await new Promise(resolve => setTimeout(resolve, 1500));
                                input.value = entry.ids[i];
                                await addPlaylist();
                            }
                        } catch (error) {
                            console.error('Error loading playlist:', error);
                            const errorMsg = document.getElementById('error-message');
                            if (errorMsg) {
                                errorMsg.textContent = `Error: ${error.message}`;
                                errorMsg.style.display = 'block';
                            }
                        }
                    };
                    
                    container.appendChild(itemDiv);
                });

            } catch (e) {
                console.error('Error in displayFavorites:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            displayFavorites();
        });

        // Add this function to initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Display history immediately on page load
            displayHistory();
        });

        // Add version number and styling
        function addStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .delete-button {
                    background: none;
                    border: none;
                    color: #666;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0 8px;
                    margin-left: 8px;
                    transition: color 0.2s;
                }

                .delete-button:hover {
                    color: #ff4444;
                }

                .history-item, .favorite-item {
                    padding: 10px;
                    margin: 5px 0;
                    background-color: #333;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                }

                .history-item:hover, .favorite-item:hover {
                    background-color: #444;
                }

                #version {
                    position: fixed;
                    bottom: 10px;
                    right: 10px;
                    color: #666;
                    font-size: 12px;
                }
            `;
            document.head.appendChild(style);
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', addStyles);

        // Hide resume button
        document.addEventListener('DOMContentLoaded', function() {
            const resumeButton = document.getElementById('resume-button');
            if (resumeButton) {
                resumeButton.style.display = 'none';
            }
        });

        // Add notification styles
        const style = document.createElement('style');
        style.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #333;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .notification.show {
                opacity: 1;
                animation: flashNotification 0.3s ease;
            }

            @keyframes flashNotification {
                0% {
                    background-color: #fff;
                    color: #333;
                }
                100% {
                    background-color: #333;
                    color: #fff;
                }
            }
        `;
        document.head.appendChild(style);

        // Update showNotification with longer duration
        function showNotification(message, duration = 5000) {
            // Remove any existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create new notification
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);

            // Remove after duration
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Update cleanupPlaylistHistory to show notification when data is cleared
        function cleanupPlaylistHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('playlistHistory') || '[]');
                
                // Filter out invalid entries
                const validHistory = history.filter(entry => {
                    return entry 
                        && Array.isArray(entry.ids) 
                        && entry.ids.length > 0
                        && Array.isArray(entry.titles)
                        && entry.titles.length > 0
                        && entry.timestamp;
                });

                // If entries were removed, show notification
                if (validHistory.length !== history.length) {
                    const removedCount = history.length - validHistory.length;
                    showNotification(`Cleaned up ${removedCount} invalid playlist${removedCount !== 1 ? 's' : ''} from history`);
                    localStorage.setItem('playlistHistory', JSON.stringify(validHistory));
                }
                
                return validHistory;
            } catch (e) {
                console.error('Error cleaning history:', e);
                showNotification('History data was reset due to corruption');
                localStorage.setItem('playlistHistory', '[]');
                return [];
            }
        }
    
    // Add version number
    document.addEventListener('DOMContentLoaded', function() {
            const versionElement = document.getElementById('version');
            if (versionElement) {
                versionElement.textContent = 'v1.0.4';
            }
        });

        function clearHistory() {
            try {
                localStorage.removeItem('playlistHistory');
                displayHistory();
                showNotification('Playlist history cleared');
            } catch (e) {
                console.error('Error clearing history:', e);
                showNotification('Error clearing playlist history');
            }
        }
    </script>
    <!-- Add version display element -->
    <div id="version"></div>
</body>
</html>
